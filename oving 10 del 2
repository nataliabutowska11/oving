import json

class Emne:
    def __init__(self, kode, navn, semester, studiepoeng):
        self._kode = kode
        self.navn = navn
        self.semester = semester.upper()  # 'H' eller 'V'
        self.studiepoeng = studiepoeng

    @property
    def kode(self):
        return self._kode  

    def __str__(self):
        return f"{self.kode} - {self.navn} ({self.semester}, {self.studiepoeng} sp)"



class Studieplan:
    def __init__(self, plan_id, tittel):
        self.plan_id = plan_id
        self.tittel = tittel
        # seks semestre (1â€“6)
        self.semestre = {i: [] for i in range(1, 7)}

    def legg_til_emne(self, emne, semester_nummer):
       
        if emne.semester == "H" and semester_nummer not in [1, 3, 5]:
            print("Feil: HÃ¸stemne kan bare legges til i 1., 3. eller 5. semester.")
            return False
        if emne.semester == "V" and semester_nummer not in [2, 4, 6]:
            print("Feil: VÃ¥remne kan bare legges til i 2., 4. eller 6. semester.")
            return False
   
        if any(e.kode == emne.kode for e in self.semestre[semester_nummer]):
            print("Feil: Emnet finnes allerede i dette semesteret.")
            return False
        
        total_sp = sum(e.studiepoeng for e in self.semestre[semester_nummer])
        if total_sp + emne.studiepoeng > 30:
            print("Feil: For mange studiepoeng i dette semesteret.")
            return False

        self.semestre[semester_nummer].append(emne)
        print(f"âœ… La til {emne.navn} i {semester_nummer}. semester.")
        return True

    def fjern_emne(self, emnekode):
        for sem, emner in self.semestre.items():
            for e in emner:
                if e.kode == emnekode:
                    emner.remove(e)
                    print(f" Fjernet {e.navn} fra {sem}. semester.")
                    return True
        print("Fant ikke emnet i studieplanen.")
        return False

    def er_gyldig(self):
        gyldig = True
        for sem, emner in self.semestre.items():
            total_sp = sum(e.studiepoeng for e in emner)
            if total_sp != 30:
                print(f"Semester {sem} har {total_sp} studiepoeng (ikke gyldig).")
                gyldig = False
        if gyldig:
            print(" Studieplanen er gyldig!")
        return gyldig

    def skriv_ut(self):
        print(f"\n--- Studieplan: {self.tittel} ---")
        for sem, emner in self.semestre.items():
            print(f"\nSemester {sem}:")
            if emner:
                for e in emner:
                    print(f"  - {e}")
            else:
                print("  (ingen emner)")

    def til_dict(self):
        return {
            "plan_id": self.plan_id,
            "tittel": self.tittel,
            "semestre": {
                str(k): [e.kode for e in v] for k, v in self.semestre.items()
            },
        }



def lagre_data(emner, studieplaner, filnavn="studieplaner.json"):
    data = {
        "emner": [
            {
                "kode": e.kode,
                "navn": e.navn,
                "semester": e.semester,
                "studiepoeng": e.studiepoeng,
            }
            for e in emner
        ],
        "studieplaner": [sp.til_dict() for sp in studieplaner],
    }
    with open(filnavn, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2)
    print(f"ðŸ’¾ Lagret data til {filnavn}.")


def les_data(filnavn="studieplaner.json"):
    try:
        with open(filnavn, "r", encoding="utf-8") as f:
            data = json.load(f)
    except FileNotFoundError:
        print("Fant ikke lagret fil, starter tomt system.")
        return [], []

    emner = [
        Emne(e["kode"], e["navn"], e["semester"], e["studiepoeng"])
        for e in data["emner"]
    ]
    studieplaner = []
    for sp in data["studieplaner"]:
        plan = Studieplan(sp["plan_id"], sp["tittel"])
        for sem_str, koder in sp["semestre"].items():
            sem = int(sem_str)
            for kode in koder:
                emne = next((e for e in emner if e.kode == kode), None)
                if emne:
                    plan.semestre[sem].append(emne)
        studieplaner.append(plan)
    print(f"ðŸ“‚ Leste inn {len(emner)} emner og {len(studieplaner)} studieplaner.")
    return emner, studieplaner


def hovedmeny(): emner, studieplaner = les_data()

while True:
    print("""
============================ MENY

Lag nytt emne

Legg til emne i studieplan

Fjern emne fra studieplan

Skriv ut alle emner

Lag ny studieplan

Skriv ut studieplan

Sjekk om studieplan er gyldig

Finn hvilke studieplaner som bruker et emne

Lagre data til fil

Les inn data fra fil

Avslutt ============================ """) valg = input("Velg et menyvalg: ")

if valg == "1":
    kode = input("Emnekode: ").upper()
    navn = input("Emnenavn: ")
    semester = input("Semester (H/V): ").upper()
    sp = int(input("Studiepoeng: "))
    emner.append(Emne(kode, navn, semester, sp))
    print("âœ… Nytt emne lagt til.")

elif valg == "2":
    if not studieplaner:
        print("Ingen studieplaner opprettet enda.")
        continue
    print("Tilgjengelige planer:")
    for sp in studieplaner:
        print(f"{sp.plan_id}: {sp.tittel}")
    pid = input("Velg plan-id: ")
    plan = next((s for s in studieplaner if s.plan_id == pid), None)
    if not plan:
        print("Fant ikke studieplanen.")
        continue
    print("Tilgjengelige emner:")
    for e in emner:
        print(f"- {e}")
    kode = input("Hvilket emne skal legges til? ").upper()
    emne = next((e for e in emner if e.kode == kode), None)
    if not emne:
        print("Fant ikke emne.")
        continue
    sem = int(input("Semester (1â€“6): "))
    plan.legg_til_emne(emne, sem)

elif valg == "3":
    pid = input("Plan-id: ")
    plan = next((s for s in studieplaner if s.plan_id == pid), None)
    if not plan:
        print("Fant ikke studieplan.")
        continue
    kode = input("Emnekode Ã¥ fjerne: ").upper()
    plan.fjern_emne(kode)

elif valg == "4":
    for e in emner:
        print(e)

elif valg == "5":
    pid = input("Ny plan-id: ")
    tittel = input("Tittel: ")
    studieplaner.append(Studieplan(pid, tittel))
    print("âœ… Ny studieplan opprettet.")

elif valg == "6":
    pid = input("Plan-id: ")
    plan = next((s for s in studieplaner if s.plan_id == pid), None)
    if plan:
        plan.skriv_ut()
    else:
        print("Fant ikke studieplan.")

elif valg == "7":
    pid = input("Plan-id: ")
    plan = next((s for s in studieplaner if s.plan_id == pid), None)
    if plan:
        plan.er_gyldig()
    else:
        print("Fant ikke studieplan.")


elif valg == "8":
    kode = input("Emnekode: ").upper()
    brukte = []
    for sp in studieplaner:
        # Sjekk om emnet brukes i noen semester i studieplanen
        if any(e.kode == kode for emner in sp.semestre.values() for e in emner):
            brukte.append(sp.tittel)

    if brukte:
        print("Emnet brukes i:", ", ".join(brukte))
    else:
        print("Emnet brukes ikke i noen studieplaner.")

elif valg == "9":
    lagre_data(emner, studieplaner)

elif valg == "10":
    emner, studieplaner = les_data()

elif valg == "11":
    print("Avslutter...")
    break

else:
    print("Ugyldig valg, prÃ¸v igjen.")
if name == "main": hovedmeny()

