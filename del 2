import json

class Emne:
    def __init__(self, kode, navn, semester, studiepoeng):
        self._kode = kode
        self.navn = navn
        self.semester = semester.upper()  # 'H' eller 'V'
        self.studiepoeng = studiepoeng

    @property
    def kode(self):
        return self._kode  

    def __str__(self):
        return f"{self.kode} - {self.navn} ({self.semester}, {self.studiepoeng} sp)"



class Studieplan:
    def __init__(self, plan_id, tittel):
        self.plan_id = plan_id
        self.tittel = tittel
        # seks semestre (1â€“6)
        self.semestre = {i: [] for i in range(1, 7)}

    def legg_til_emne(self, emne, semester_nummer):
       
        if emne.semester == "H" and semester_nummer not in [1, 3, 5]:
            print("Feil: HÃ¸stemne kan bare legges til i 1., 3. eller 5. semester.")
            return False
        if emne.semester == "V" and semester_nummer not in [2, 4, 6]:
            print("Feil: VÃ¥remne kan bare legges til i 2., 4. eller 6. semester.")
            return False
   
        if any(e.kode == emne.kode for e in self.semestre[semester_nummer]):
            print("Feil: Emnet finnes allerede i dette semesteret.")
            return False
        
        total_sp = sum(e.studiepoeng for e in self.semestre[semester_nummer])
        if total_sp + emne.studiepoeng > 30:
            print("Feil: For mange studiepoeng i dette semesteret.")
            return False

        self.semestre[semester_nummer].append(emne)
        print(f"âœ… La til {emne.navn} i {semester_nummer}. semester.")
        return True

    def fjern_emne(self, emnekode):
        for sem, emner in self.semestre.items():
            for e in emner:
                if e.kode == emnekode:
                    emner.remove(e)
                    print(f" Fjernet {e.navn} fra {sem}. semester.")
                    return True
        print("Fant ikke emnet i studieplanen.")
        return False

    def er_gyldig(self):
        gyldig = True
        for sem, emner in self.semestre.items():
            total_sp = sum(e.studiepoeng for e in emner)
            if total_sp != 30:
                print(f"Semester {sem} har {total_sp} studiepoeng (ikke gyldig).")
                gyldig = False
        if gyldig:
            print(" Studieplanen er gyldig!")
        return gyldig

    def skriv_ut(self):
        print(f"\n--- Studieplan: {self.tittel} ---")
        for sem, emner in self.semestre.items():
            print(f"\nSemester {sem}:")
            if emner:
                for e in emner:
                    print(f"  - {e}")
            else:
                print("  (ingen emner)")

    def til_dict(self):
        return {
            "plan_id": self.plan_id,
            "tittel": self.tittel,
            "semestre": {
                str(k): [e.kode for e in v] for k, v in self.semestre.items()
            },
        }



def lagre_data(emner, studieplaner, filnavn="studieplaner.json"):
    data = {
        "emner": [
            {
                "kode": e.kode,
                "navn": e.navn,
                "semester": e.semester,
                "studiepoeng": e.studiepoeng,
            }
            for e in emner
        ],
        "studieplaner": [sp.til_dict() for sp in studieplaner],
    }
    with open(filnavn, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2)
    print(f"ğŸ’¾ Lagret data til {filnavn}.")


def les_data(filnavn="studieplaner.json"):
    try:
        with open(filnavn, "r", encoding="utf-8") as f:
            data = json.load(f)
    except FileNotFoundError:
        print("Fant ikke lagret fil, starter tomt system.")
        return [], []

    emner = [
        Emne(e["kode"], e["navn"], e["semester"], e["studiepoeng"])
        for e in data["emner"]
    ]
    studieplaner = []
    for sp in data["studieplaner"]:
        plan = Studieplan(sp["plan_id"], sp["tittel"])
        for sem_str, koder in sp["semestre"].items():
            sem = int(sem_str)
            for kode in koder:
                emne = next((e for e in emner if e.kode == kode), None)
                if emne:
                    plan.semestre[sem].append(emne)
        studieplaner.append(plan)
    print(f"ğŸ“‚ Leste inn {len(emner)} emner og {len(studieplaner)} studieplaner.")
    return emner, studieplaner
